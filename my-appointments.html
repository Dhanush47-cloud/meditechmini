<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Appointments - MediTech</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 25px;
        background: linear-gradient(135deg, #e6f2ff, #ffffff);
    }

    .container {
        max-width: 760px;
        margin: auto;
        background: #fff;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        border-top: 5px solid #007bff;
    }

    h2 {
        color: #007bff;
        text-align: center;
        margin-bottom: 20px;
    }

    .appt-card {
        border: 1.5px solid #d9e6ff;
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 18px;
        background: #f8faff;
    }

    .appt-card h3 { margin: 0; color:#007bff; }
    .appt-card p { margin: 5px 0; color:#444; }

    .cancel-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 10px 22px;
        background:#ff4d4d;
        color:#fff;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-weight:600;
    }

    .cancel-btn:hover { background:#d93636; }

    .back {
        display:block;
        width:100%;
        text-align:center;
        margin-top:20px;
        padding:12px;
        background:#007bff;
        color:#fff;
        border-radius:10px;
        text-decoration:none;
        font-weight:700;
    }
</style>
</head>

<body>

<div class="container">
    <h2>My Appointments</h2>
    <div id="appointmentsList"></div>
    <a href="patient-dashboard.html" class="back">Back to Dashboard</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAouRcoDjAVMNZmUkePlzNxUHD6DXxbxco",
  authDomain: "meditech-83cbc.firebaseapp.com",
  projectId: "meditech-83cbc",
  storageBucket: "meditech-83cbc.appspot.com",
  messagingSenderId: "687068515209",
  appId: "1:687068515209:web:c4d007ce8abfc4fcb76f58"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Hide loader
function hideLoader() {
    const loader = document.getElementById("loader");
    loader.style.animation = "fadeOut 0.3s forwards";
    setTimeout(() => (loader.style.display = "none"), 300);
}

const list = document.getElementById("appointmentsList");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    const q = query(collection(db, "appointments"), where("patient_id", "==", user.uid));
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = "<p>No appointments found.</p>";
      hideLoader();
      return;
    }

    snap.forEach(docSnap => {
      const a = docSnap.data();

      const div = document.createElement("div");
      div.className = "appt-card";

      div.innerHTML = `
        <h3>${a.doctor_name}</h3>
        <p><strong>Department:</strong> ${a.department}</p>
        <p><strong>Date:</strong> ${a.appointment_date}</p>
        <p><strong>Time:</strong> ${a.appointment_time}</p>
        <p><strong>Status:</strong> ${a.status}</p>
        <button class="cancel-btn" data-id="${docSnap.id}">Cancel Appointment</button>
      `;

      list.appendChild(div);
    });

    // Cancel appointment logic
    document.querySelectorAll(".cancel-btn").forEach(btn => {
      btn.addEventListener("click", async () => {

        if (!confirm("Are you sure you want to cancel this appointment?")) return;

        const id = btn.getAttribute("data-id");

        try {
          await deleteDoc(doc(db, "appointments", id));

          btn.disabled = true;
          btn.textContent = "Cancelled";
          btn.style.background = "#999";

          alert("Appointment cancelled successfully!");
          setTimeout(() => location.reload(), 600);

        } catch (err) {
          alert("Error cancelling appointment: " + err.message);
        }
      });
    });

    hideLoader();

  } catch (err) {
    hideLoader();
  }
});
</script>


</body>
</html>
